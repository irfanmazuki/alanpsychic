<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Booking Management</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css"
    />
    <style>
      body {
        background: #f4f8f9;
        padding: 20px;
      }

      h1 {
        text-align: center;
        color: #0abab5;
        margin-bottom: 20px;
      }

      .modal-content {
        border-radius: 10px;
      }

      .filter {
        text-align: center;
        margin-bottom: 20px;
      }
    </style>
  </head>
  <body>
    <h1>Booking Slot Management</h1>

    <div class="filter">
      <label for="filterDate">Filter by Date: </label>
      <input type="date" id="filterDate" />
    </div>
    <div class="mb-4 text-center">
      <p>
        <strong>Slots currently filled until:</strong>
        <span id="latestDate">Loading...</span>
      </p>
      <div class="d-flex justify-content-center align-items-center gap-2 mt-3">
        <input
          type="date"
          id="addUntilDate"
          class="form-control"
          style="max-width: 200px"
        />
        <button class="btn btn-primary" onclick="addSlots()">Add Slots</button>
      </div>
    </div>

    <div class="table-responsive">
      <table id="slotsTable" class="table table-bordered text-center">
        <thead class="table-primary">
          <tr>
            <th>Date</th>
            <th>Time</th>
            <th>Availability</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          <!-- Rows will be injected here -->
        </tbody>
      </table>
    </div>

    <div class="modal fade" id="bookingModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Booking Details</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body" id="modalDetails"></div>
        </div>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
    <script>
      var slotsData = [];
      var latestFilledDate = null;
      var table;

      function loadSlots() {
        $.ajax({
          url: "../api/api.php?action=get_timeslots",
          method: "GET",
          success: function (response) {
            slotsData = response;
            populateTable();

            if ($.fn.DataTable.isDataTable("#slotsTable")) {
              table.destroy();
            }

            table = $("#slotsTable").DataTable({
              pageLength: 12,
              lengthChange: false,
            });

            if (slotsData.length > 0) {
              latestFilledDate = slotsData[slotsData.length - 1].date;
              $("#latestDate").text(latestFilledDate);
            } else {
              $("#latestDate").text("No slots available yet.");
            }

            if (slotsData.length > 0) {
              latestFilledDate = slotsData[slotsData.length - 1].date;
              $("#latestDate").text(latestFilledDate);

              // Set minimum date for the picker
              const minDate = new Date(latestFilledDate);
              minDate.setDate(minDate.getDate() + 1); // +1 day
              $("#addUntilDate").attr(
                "min",
                minDate.toISOString().split("T")[0]
              );
              $("#addUntilDate").val("");
            } else {
              $("#latestDate").text("No slots available yet.");
            }
          },
          error: function (xhr, status, error) {
            console.error("AJAX Error:", error);
          },
        });
      }

      function addSlots() {
        const untilDate = $("#addUntilDate").val();
        if (!untilDate) {
          alert("Please select a date to add slots until.");
          return;
        }
        if (!latestFilledDate) {
          alert(
            "Cannot determine the latest filled date. Please refresh the page."
          );
          return;
        }
        if (untilDate <= latestFilledDate) {
          alert("The new date must be later than the latest filled date!");
          return;
        }

        if (
          !confirm(`Add slots from ${latestFilledDate} until ${untilDate}?`)
        ) {
          return;
        }

        $.ajax({
          url: "../api/api.php?action=add_slots",
          method: "POST",
          data: { from: latestFilledDate, to: untilDate },
          success: function (response) {
            if (response.success) {
              alert("Slots successfully added!");
              loadSlots(); // reload after add
            } else {
              alert("Failed to add slots: " + response.message);
            }
          },
          error: function (xhr, status, error) {
            console.error("AJAX Error:", error);
            alert("Error occurred while adding slots.");
          },
        });
      }

      function deleteSlot(id) {
        if (!confirm("Are you sure you want to delete this slot?")) {
          return;
        }

        $.ajax({
          url: "../api/api.php?action=delete_slot",
          method: "POST",
          data: { id: id },
          success: function (response) {
            if (response.success) {
              alert("Slot deleted successfully!");
              loadSlots(); // reload after delete
            } else {
              alert("Failed to delete slot: " + response.message);
            }
          },
          error: function (xhr, status, error) {
            console.error("AJAX Error:", error);
            alert("Error occurred while deleting slot.");
          },
        });
      }

      function populateTable() {
        const tbody = $("#slotsTable tbody");
        tbody.empty();
        slotsData.sort((a, b) => a.date.localeCompare(b.date));

        let currentDate = "";
        let stripeClass = "";

        slotsData.forEach((slot) => {
          if (slot.date !== currentDate) {
            currentDate = slot.date;
            stripeClass =
              stripeClass === "table-light" ? "table-secondary" : "table-light"; // toggle between two styles
          }

          const row = `
<tr class="${stripeClass}">
  <td>${slot.date}</td>
  <td>${slot.time}</td>
  <td>
    ${
      slot.availability == 1
        ? "Available"
        : `<button class="btn btn-info btn-sm" onclick="openModal(${slot.id})">View Booking</button>`
    }
  </td>
  <td>
    <button class="btn btn-danger btn-sm" onclick="deleteSlot(${
      slot.id
    })">Delete</button>
  </td>
</tr>
`;
          tbody.append(row);
        });
      }

      function openModal(id) {
        const slot = slotsData.find((s) => s.id === id);
        if (slot) {
          $("#modalDetails").html(`
        <p><strong>ID:</strong> ${slot.id}</p>
        <p><strong>Date:</strong> ${slot.date}</p>
        <p><strong>Time:</strong> ${slot.time}</p>
        <p><strong>Status:</strong> ${
          slot.availability ? "Available" : "Booked"
        }</p>
      `);
          const bookingModal = new bootstrap.Modal(
            document.getElementById("bookingModal")
          );
          bookingModal.show();
        }
      }

      $(document).ready(function () {
        loadSlots(); // Only call loadSlots
        $("#filterDate").on("change", function () {
          const filterDate = this.value;
          table.column(0).search(filterDate).draw();
        });
      });
    </script>
  </body>
</html>
