<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Booking Management</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css"
    />
    <style>
      body {
        background: #f4f8f9;
        padding: 20px;
      }

      h1 {
        text-align: center;
        color: #0abab5;
        margin-bottom: 20px;
      }

      .modal-content {
        border-radius: 10px;
      }

      .filter {
        text-align: center;
        margin-bottom: 20px;
      }
    </style>
  </head>
  <body>
    <h1>Booking Slot Management</h1>

    <div class="filter">
      <label for="filterDate">Filter by Date: </label>
      <input type="date" id="filterDate" />
    </div>

    <div class="table-responsive">
      <table id="slotsTable" class="table table-bordered text-center">
        <thead class="table-primary">
          <tr>
            <th>Date</th>
            <th>Time</th>
            <th>Availability</th>
          </tr>
        </thead>
        <tbody>
          <!-- Rows will be injected here -->
        </tbody>
      </table>
    </div>

    <div class="modal fade" id="bookingModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Booking Details</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body" id="modalDetails"></div>
        </div>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
    <script>
      var slotsData = [];

      var table; // move this to global scope

      function loadSlots() {
        $.ajax({
          url: "../api/api.php?action=get_timeslots",
          method: "GET",
          success: function (response) {
            slotsData = response;
            populateTable();

            if ($.fn.DataTable.isDataTable("#slotsTable")) {
              table.destroy(); // destroy previous table instance first
            }

            table = $("#slotsTable").DataTable({
              pageLength: 12,
              lengthChange: false,
            });
          },
          error: function (xhr, status, error) {
            console.error("AJAX Error:", error);
          },
        });
      }

      function populateTable() {
        const tbody = $("#slotsTable tbody");
        tbody.empty();
        slotsData.sort((a, b) => a.date.localeCompare(b.date));

        let currentDate = "";
        let stripeClass = "";

        slotsData.forEach((slot) => {
          if (slot.date !== currentDate) {
            currentDate = slot.date;
            stripeClass =
              stripeClass === "table-light" ? "table-secondary" : "table-light"; // toggle between two styles
          }

          const row = `
        <tr class="${stripeClass}">
          <td>${slot.date}</td>
          <td>${slot.time}</td>
          <td>
            ${
              slot.availability == 1
                ? "Available"
                : `<button class="btn btn-info btn-sm" onclick="openModal(${slot.id})">View</button>`
            }
          </td>
        </tr>
      `;
          tbody.append(row);
        });
      }

      function openModal(id) {
        const slot = slotsData.find((s) => s.id === id);
        if (slot) {
          $("#modalDetails").html(`
        <p><strong>ID:</strong> ${slot.id}</p>
        <p><strong>Date:</strong> ${slot.date}</p>
        <p><strong>Time:</strong> ${slot.time}</p>
        <p><strong>Status:</strong> ${
          slot.availability ? "Available" : "Booked"
        }</p>
      `);
          const bookingModal = new bootstrap.Modal(
            document.getElementById("bookingModal")
          );
          bookingModal.show();
        }
      }

      $(document).ready(function () {
        loadSlots(); // Only call loadSlots
        $("#filterDate").on("change", function () {
          const filterDate = this.value;
          table.column(0).search(filterDate).draw();
        });
      });
    </script>
  </body>
</html>
