<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Booking Website</title>
    <style>
      body {
        background-color: #81d8d0;
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
      }

      .booking-form {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
        max-width: 400px;
        width: 100%;
      }

      .booking-form h2 {
        text-align: center;
        color: #0abab5;
      }

      .form-group {
        margin-bottom: 15px;
      }

      label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
      }

      input,
      select,
      button {
        width: 95%;
        padding: 10px;
        margin-top: 5px;
        border: 1px solid #ccc;
        border-radius: 5px;
      }

      .time-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 10px;
        min-height: 80px;
        align-items: center;
        justify-content: center;
        border: 2px dotted #ccc;
        padding: 20px;
        text-align: center;
      }

      .placeholder-text {
        color: #666;
        font-style: italic;
      }

      .time-button {
        flex: 1 1 calc(45% - 10px);
        background-color: #30a8db;
        color: white;
        border: none;
        padding: 10px;
        border-radius: 5px;
        cursor: pointer;
        text-align: center;
        box-sizing: border-box;
      }

      .time-button.disabled {
        background-color: #cccccc;
        cursor: not-allowed;
      }

      .time-button.selected {
        background-color: #089e9a;
      }

      button[type="submit"] {
        background-color: #0abab5;
        color: white;
        font-weight: bold;
        border: none;
        cursor: pointer;
      }

      button[type="submit"]:hover {
        background-color: #089e9a;
      }

      @media (max-width: 600px) {
        .booking-form {
          padding: 15px;
        }
      }
    </style>
  </head>
  <body>
    <form class="booking-form" id="bookingForm">
      <h2>Book Your Slot</h2>

      <div class="form-group">
        <label for="name">Name</label>
        <input type="text" id="name" required />
      </div>

      <div class="form-group">
        <label for="phone">Phone Number</label>
        <div style="display: flex; align-items: center">
          <span
            style="
              margin-top: 5px;
              padding: 10px;
              background: #eee;
              border-right: none;
              border-radius: 5px 0 0 5px;
            "
            >+60</span
          >
          <input
            type="tel"
            id="phone"
            style="border-radius: 0 5px 5px 0; border-left: none"
            required
          />
        </div>
      </div>

      <div class="form-group">
        <label for="email">Email</label>
        <input type="email" id="email" required />
      </div>

      <div class="form-group">
        <label for="pax">Number of Pax</label>
        <select id="pax" required>
          <option value="">Select pax</option>
        </select>
      </div>

      <div class="form-group">
        <label for="date">Date</label>
        <select id="date" required>
          <option value="">Select date</option>
        </select>
      </div>

      <div class="form-group">
        <label>Time</label>
        <div class="time-buttons" id="timeButtons">
          <div class="placeholder-text" id="placeholderText">
            Please select pax number and date
          </div>
        </div>
      </div>

      <input type="hidden" id="selectedTime" name="selectedTime" required />

      <button type="submit">Submit Booking</button>
    </form>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script>
      if (localStorage.getItem("auth") !== "granted") {
        alert("Please enter the password before accessing the booking page");
        window.location.href = "index.html"; // Redirect back if not authorized
      }
      const paxSelect = document.getElementById("pax");
      const dateSelect = document.getElementById("date");
      const timeButtonsDiv = document.getElementById("timeButtons");
      const selectedTimeInput = document.getElementById("selectedTime");
      let selectedTimeIds = [];
      let selectedTimeLabels = [];

      var slotsData = [];

      function loadSlotsData() {
        $.ajax({
          url: "api/api.php?action=get_booking_slots", // <-- new function in api.php
          method: "GET",
          success: function (response) {
            slotsData = response;
            reloadDateOptions();
          },
          error: function (xhr, status, error) {
            console.error("Failed to load slots:", error);
          },
        });
      }

      function findConsecutiveSlots(slots, pax) {
        for (let i = 0; i <= slots.length - pax; i++) {
          let allAvailable = true;
          for (let j = 0; j < pax; j++) {
            if (!slots[i + j] || !slots[i + j].available) {
              allAvailable = false;
              break;
            }
          }
          if (allAvailable) return true;
        }
        return false;
      }

      function reloadDateOptions() {
        const pax = parseInt(paxSelect.value) || 1;
        dateSelect.innerHTML = '<option value="">Select date</option>';

        slotsData.forEach((day) => {
          const hasConsecutive = findConsecutiveSlots(day.slots, pax);
          const option = document.createElement("option");
          option.value = day.date;
          option.textContent = hasConsecutive
            ? day.date
            : `${day.date} (Fully booked)`;
          if (!hasConsecutive) {
            option.disabled = true;
            option.style.color = "gray";
          }
          dateSelect.appendChild(option);
        });
      }

      function bookingSlot() {
        const name = $("#name").val().trim();
        const phone = $("#phone").val().trim();
        const email = $("#email").val().trim();
        const pax = $("#pax").val();
        const date = $("#date").val();

        if (!selectedTimeIds.length) {
          alert("Please select a time slot!");
          return;
        }

        const confirmBooking = confirm(
          `Confirm booking for:\n\nName: ${name}\nPhone: +60${phone}\nEmail: ${email}\nPax: ${pax}\nDate: ${date}\nTimes: ${selectedTimeLabels.join(
            ", "
          )}`
        );
        if (!confirmBooking) return;

        $.ajax({
          url: "api/api.php?action=submit_booking",
          method: "POST",
          data: {
            name: name,
            phone: phone,
            email: email,
            pax: pax,
            timeslot_ids: selectedTimeIds, // Send ID list
          },
          success: function (response) {
            if (response.success) {
              alert("Booking successful!");
              window.location.href =
                "booking-confirmation.html?booking_number=" +
                response.booking_number;
            } else {
              alert("Booking failed: " + response.message);
            }
          },
          error: function (xhr, status, error) {
            console.error("AJAX Error:", error);
            alert("Error occurred while submitting booking.");
          },
        });
      }

      function generateTimeButtons(pax) {
        timeButtonsDiv.innerHTML = "";
        console.log(slotsData);
        const selectedDay = slotsData.find(
          (day) => day.date === dateSelect.value
        );
        if (!selectedDay) return;

        selectedDay.slots.forEach((slot, index) => {
          const button = document.createElement("button");
          button.type = "button";
          button.className = "time-button";
          button.textContent = slot.time;
          button.dataset.index = index;
          button.dataset.id = slot.id;

          // Check if enough consecutive slots are available from this slot
          let consecutiveAvailable = true;
          if (index + pax > selectedDay.slots.length) {
            consecutiveAvailable = false;
          } else {
            for (let i = 0; i < pax; i++) {
              if (!selectedDay.slots[index + i]?.available) {
                consecutiveAvailable = false;
                break;
              }
            }
          }

          if (!consecutiveAvailable) {
            button.disabled = true;
            button.classList.add("disabled");
          }

          button.addEventListener("click", function () {
            if (this.classList.contains("disabled")) return;

            document
              .querySelectorAll(".time-button")
              .forEach((btn) => btn.classList.remove("selected"));
            selectedTimeIds = [];
            selectedTimeLabels = [];

            const startIdx = parseInt(this.dataset.index);
            for (let i = 0; i < pax; i++) {
              const btn = document.querySelector(
                `.time-button[data-index='${startIdx + i}']`
              );
              if (btn) {
                btn.classList.add("selected");
                selectedTimeIds.push(btn.dataset.id);
                selectedTimeLabels.push(btn.textContent);
              }
            }

            selectedTimeInput.value = selectedTimeIds.join(","); // Save only IDs into hidden input
          });

          timeButtonsDiv.appendChild(button);
        });
      }

      dateSelect.addEventListener("change", function () {
        if (paxSelect.value) generateTimeButtons(parseInt(paxSelect.value));
      });

      paxSelect.addEventListener("change", function () {
        reloadDateOptions();
        timeButtonsDiv.innerHTML = ""; // Clear time buttons when pax changed
        selectedTimeInput.value = ""; // Clear selected time
      });

      document
        .getElementById("bookingForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          if (!selectedTimeInput.value) {
            alert("Please select a time slot!");
            return;
          }
          bookingSlot();
        });

      // Initialize
      [1, 2, 3, 4, 5, 6].forEach((p) => {
        const option = document.createElement("option");
        option.value = p;
        option.textContent = `${p} pax`;
        paxSelect.appendChild(option);
      });
      reloadDateOptions();

      $(document).ready(function () {
        loadSlotsData();
      });
    </script>
  </body>
</html>
